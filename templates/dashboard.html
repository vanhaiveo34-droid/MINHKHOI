{% extends "base.html" %}

{% block title %}Dashboard - HỆ THỐNG ĐIỀU PHIẾU MINH KHÔI{% endblock %}

{% block content %}
<div class="card">
    <h1 style="margin-bottom: 1rem; color: #667eea;">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </h1>
    
    <!-- Thống kê -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ tickets|length }}</div>
            <div class="stat-label">Tổng số phiếu</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tickets|selectattr('status', 'equalto', 'cho_xu_ly')|list|length }}</div>
            <div class="stat-label">Chờ xử lý</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tickets|selectattr('status', 'equalto', 'dang_xu_ly')|list|length }}</div>
            <div class="stat-label">Đang xử lý</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ tickets|selectattr('status', 'equalto', 'hoan_thanh')|list|length }}</div>
            <div class="stat-label">Hoàn thành</div>
        </div>
    </div>
    
    <!-- Nút quản lý nhân viên cho quản trị viên -->
    {% if current_user.role == 'quan_tri_vien' %}
    <div style="text-align: right; margin-bottom: 1rem;">
        <a href="{{ url_for('admin_users') }}" class="btn btn-info">
            <i class="fas fa-users"></i> Quản lý nhân viên
        </a>
    </div>
    {% endif %}
    
    <!-- Bộ lọc và tìm kiếm -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="grid grid-3">
            <div class="form-group">
                <label for="search-input" class="form-label">
                    <i class="fas fa-search"></i> Tìm kiếm
                </label>
                <input type="text" id="search-input" class="form-control" placeholder="Tìm theo số phiếu hoặc tên khách hàng...">
            </div>
            <div class="form-group">
                <label for="status-filter" class="form-label">
                    <i class="fas fa-filter"></i> Lọc theo trạng thái
                </label>
                <select id="status-filter" class="form-select">
                    <option value="">Tất cả trạng thái</option>
                    <option value="cho_xu_ly">Chờ xử lý</option>
                    <option value="da_phan_cong">Đã phân công</option>
                    <option value="dang_xu_ly">Đang xử lý</option>
                    <option value="hoan_thanh">Hoàn thành</option>
                    <option value="da_huy">Đã hủy</option>
                </select>
            </div>
            <div class="form-group">
                <label for="priority-filter" class="form-label">
                    <i class="fas fa-exclamation-triangle"></i> Lọc theo độ ưu tiên
                </label>
                <select id="priority-filter" class="form-select">
                    <option value="">Tất cả độ ưu tiên</option>
                    <option value="thap">Thấp</option>
                    <option value="trung_binh">Trung bình</option>
                    <option value="cao">Cao</option>
                    <option value="khan_cap">Khẩn cấp</option>
                </select>
            </div>
        </div>
        
        <div style="text-align: right; margin-top: 1rem;">
            <button onclick="exportTickets()" class="btn btn-secondary">
                <i class="fas fa-download"></i> Xuất Excel
            </button>
        </div>
    </div>
    
    <!-- Danh sách phiếu -->
    <div class="ticket-grid">
        {% for ticket in tickets %}
        <div class="ticket-card">
            <div class="ticket-header">
                <div class="ticket-number">{{ ticket.ticket_number }}</div>
                <div class="ticket-priority priority-{{ ticket.priority }}">
                    {{ ticket.priority.upper() }}
                </div>
            </div>
            
            <div class="ticket-status status-{{ ticket.status }}" style="margin-bottom: 1rem;">
                {{ ticket.status.replace('_', ' ').upper() }}
            </div>
            
            <div class="ticket-info">
                <h3>{{ ticket.customer_name }}</h3>
                <p><strong>Địa chỉ:</strong> {{ ticket.customer_address }}</p>
                {% if ticket.customer_location %}
                <p><strong>Định vị:</strong> {{ ticket.customer_location }}</p>
                {% endif %}
                <p><strong>SĐT:</strong> {{ ticket.customer_phone }}</p>
                <p><strong>Mô tả:</strong> {{ ticket.description }}</p>
                <p><strong>Ngày tạo:</strong> {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% if ticket.assigned_at %}
                <p><strong>Ngày phân công:</strong> {{ ticket.assigned_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% endif %}
                {% if ticket.accepted_at %}
                <p><strong>Ngày nhận:</strong> {{ ticket.accepted_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% endif %}
                {% if ticket.completed_at %}
                <p><strong>Ngày hoàn thành:</strong> {{ ticket.completed_at.strftime('%d/%m/%Y %H:%M') }}</p>
                {% endif %}

                {% if ticket.technician %}
                <p><strong>Kỹ thuật viên:</strong> {{ ticket.technician.username }}</p>
                {% endif %}
                {% if ticket.completion_notes %}
                <p><strong>Ghi chú:</strong> {{ ticket.completion_notes }}</p>
                {% endif %}
            </div>
            
            <div class="ticket-actions">
                <!-- Nút điều phiếu cho quản lý -->
                {% if current_user.role in ['quan_ly', 'quan_tri_vien'] and ticket.status == 'cho_xu_ly' %}
                <button onclick="openModal('assignModal{{ ticket.id }}')" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Điều phiếu
                </button>
                {% endif %}
                
                <!-- Nút nhận phiếu cho kỹ thuật viên -->
                {% if current_user.role == 'ky_thuat_vien' and ticket.assigned_to == current_user.id and ticket.status == 'da_phan_cong' %}
                <button class="btn btn-success accept-ticket-btn" data-ticket-id="{{ ticket.id }}">
                    <i class="fas fa-check"></i> Nhận phiếu
                </button>
                {% endif %}
                
                <!-- Nút hoàn thành phiếu cho kỹ thuật viên -->
                {% if current_user.role == 'ky_thuat_vien' and ticket.assigned_to == current_user.id and ticket.status == 'dang_xu_ly' %}
                <button onclick="openModal('completeModal{{ ticket.id }}')" class="btn btn-warning">
                    <i class="fas fa-flag-checkered"></i> Hoàn thành
                </button>
                {% endif %}
                
                <!-- Nút cập nhật trạng thái cho quản lý -->
                {% if current_user.role in ['quan_ly', 'quan_tri_vien'] %}
                <button onclick="openModal('updateModal{{ ticket.id }}')" class="btn btn-secondary">
                    <i class="fas fa-edit"></i> Cập nhật
                </button>
                {% endif %}
                
                <!-- Nút chỉnh sửa thông tin phiếu cho người tạo, quản lý và quản trị viên -->
                {% if (current_user.role == 'kinh_doanh' and ticket.created_by == current_user.id) or current_user.role in ['quan_ly', 'quan_tri_vien'] %}
                <a href="{{ url_for('edit_ticket', ticket_id=ticket.id) }}" class="btn btn-info">
                    <i class="fas fa-edit"></i> Chỉnh sửa
                </a>
                {% endif %}
                
                <!-- Nút xóa phiếu cho người tạo hoặc quản trị viên -->
                {% if (current_user.role == 'kinh_doanh' and ticket.created_by == current_user.id and ticket.status == 'cho_xu_ly') or current_user.role == 'quan_tri_vien' %}
                <button class="btn btn-danger delete-ticket-btn" data-ticket-id="{{ ticket.id }}">
                    <i class="fas fa-trash"></i> Xóa phiếu
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Modal điều phiếu -->
        {% if current_user.role in ['quan_ly', 'quan_tri_vien'] and ticket.status == 'cho_xu_ly' %}
        <div id="assignModal{{ ticket.id }}" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2><i class="fas fa-user-plus"></i> Điều phiếu {{ ticket.ticket_number }}</h2>
                <p><strong>Khách hàng:</strong> {{ ticket.customer_name }}</p>
                <p><strong>Mô tả:</strong> {{ ticket.description }}</p>
                
                <div class="form-group">
                    <label for="technician-{{ ticket.id }}" class="form-label">Chọn kỹ thuật viên:</label>
                    <select id="technician-{{ ticket.id }}" class="form-select">
                        <option value="">Chọn kỹ thuật viên...</option>
                    </select>
                    <small class="form-text text-muted">Chỉ hiển thị kỹ thuật viên đang online</small>
                </div>
                
                <div id="no-technicians-{{ ticket.id }}" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Không có kỹ thuật viên nào đang online. Không thể điều phiếu!
                </div>
                
                <div style="text-align: right; margin-top: 2rem;">
                    <button class="btn btn-secondary close-modal-btn" data-modal="assignModal{{ ticket.id }}">Hủy</button>
                    <button id="assign-btn-{{ ticket.id }}" class="btn btn-primary assign-ticket-btn" data-ticket-id="{{ ticket.id }}">Điều phiếu</button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Modal hoàn thành phiếu -->
        {% if current_user.role == 'ky_thuat_vien' and ticket.assigned_to == current_user.id and ticket.status == 'dang_xu_ly' %}
        <div id="completeModal{{ ticket.id }}" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2><i class="fas fa-flag-checkered"></i> Hoàn thành phiếu {{ ticket.ticket_number }}</h2>
                <p><strong>Khách hàng:</strong> {{ ticket.customer_name }}</p>
                <p><strong>Mô tả:</strong> {{ ticket.description }}</p>
                
                <div class="form-group">
                    <label for="completion-notes-{{ ticket.id }}" class="form-label">Ghi chú hoàn thành:</label>
                    <textarea id="completion-notes-{{ ticket.id }}" class="form-control" rows="4" placeholder="Nhập ghi chú về công việc đã hoàn thành...">{{ ticket.completion_notes or '' }}</textarea>
                </div>
                
                <div style="text-align: right; margin-top: 2rem;">
                    <button class="btn btn-secondary close-modal-btn" data-modal="completeModal{{ ticket.id }}">Hủy</button>
                    <button class="btn btn-success complete-ticket-btn" data-ticket-id="{{ ticket.id }}">Hoàn thành</button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Modal cập nhật trạng thái -->
        {% if current_user.role in ['quan_ly', 'quan_tri_vien'] %}
        <div id="updateModal{{ ticket.id }}" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2><i class="fas fa-edit"></i> Cập nhật phiếu {{ ticket.ticket_number }}</h2>
                
                <div class="form-group">
                    <label for="status-{{ ticket.id }}" class="form-label">Trạng thái:</label>
                    <select id="status-{{ ticket.id }}" class="form-select">
                        <option value="cho_xu_ly" {% if ticket.status == 'cho_xu_ly' %}selected{% endif %}>Chờ xử lý</option>
                        <option value="da_phan_cong" {% if ticket.status == 'da_phan_cong' %}selected{% endif %}>Đã phân công</option>
                        <option value="dang_xu_ly" {% if ticket.status == 'dang_xu_ly' %}selected{% endif %}>Đang xử lý</option>
                        <option value="hoan_thanh" {% if ticket.status == 'hoan_thanh' %}selected{% endif %}>Hoàn thành</option>
                        <option value="da_huy" {% if ticket.status == 'da_huy' %}selected{% endif %}>Đã hủy</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes-{{ ticket.id }}" class="form-label">Ghi chú:</label>
                    <textarea id="notes-{{ ticket.id }}" class="form-control" rows="4" placeholder="Nhập ghi chú về công việc...">{{ ticket.completion_notes or '' }}</textarea>
                </div>
                
                <div style="text-align: right; margin-top: 2rem;">
                    <button class="btn btn-secondary close-modal-btn" data-modal="updateModal{{ ticket.id }}">Hủy</button>
                    <button class="btn btn-primary update-ticket-btn" data-ticket-id="{{ ticket.id }}">Cập nhật</button>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    {% if not tickets %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <i class="fas fa-inbox" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
        <h3 style="color: #666;">Chưa có phiếu nào</h3>
        <p style="color: #999;">Hãy tạo phiếu mới để bắt đầu quản lý</p>
        {% if current_user.role in ['kinh_doanh', 'quan_tri_vien'] %}
        <a href="{{ url_for('new_ticket') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Tạo phiếu mới
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Thêm event listeners khi trang được load
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners cho nút nhận phiếu
    document.querySelectorAll('.accept-ticket-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            acceptTicket(ticketId);
        });
    });
    
    // Event listeners cho nút xóa phiếu
    document.querySelectorAll('.delete-ticket-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            deleteTicket(ticketId);
        });
    });
    
    // Event listeners cho nút điều phiếu
    document.querySelectorAll('.assign-ticket-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            assignTicket(ticketId);
        });
    });
    
    // Event listeners cho nút hoàn thành phiếu
    document.querySelectorAll('.complete-ticket-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            completeTicket(ticketId);
        });
    });
    
    // Event listeners cho nút cập nhật phiếu
    document.querySelectorAll('.update-ticket-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            updateTicketStatus(ticketId);
        });
    });
    
    // Event listeners cho nút đóng modal
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal');
            closeModal(modalId);
        });
    });
});
</script>
{% endblock %}
